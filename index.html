<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Lucky Pit ‚Äî Correcci√≥n final (combinaciones completas, estabilidad)</title>
  <style>
    :root{--bg:#04101a;--card:#071226;--accent:#ffd166;--accent2:#ff8a66;--muted:#9aa4b2}
    *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#04101a,#071226);color:#e6eef6}
    .app{max-width:1200px;margin:18px auto;padding:14px}
    h1{margin:0 0 8px 0;font-size:20px}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:16px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:14px;box-shadow:0 8px 28px rgba(0,0,0,0.6)}
    .reels{display:flex;gap:12px;justify-content:center;align-items:center;height:170px}
    .reel{width:120px;height:150px;background:rgba(255,255,255,0.015);border-radius:12px;overflow:hidden;position:relative;border:1px solid rgba(255,255,255,0.02)}
    .strip{position:absolute;left:0;right:0;top:0;will-change:transform}
    .cell{height:46px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:24px}
    .cell.bg{background:rgba(255,255,255,0.02);border-radius:8px;margin:4px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:12px}
    button{background:var(--accent);border:none;padding:10px 14px;border-radius:10px;font-weight:800;color:#081226;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .history{max-height:140px;overflow:auto;padding:6px;background:rgba(0,0,0,0.14);border-radius:8px;margin-top:12px}
    .store{max-height:360px;overflow:auto;padding:8px;margin-top:10px}
    .amulet-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.012);margin-bottom:6px}
    .amulet-row.locked{opacity:0.45}
    .activelog{max-height:140px;overflow:auto;padding:6px;background:rgba(0,0,0,0.12);border-radius:8px;margin-top:12px}
    .progress{display:flex;gap:8px;align-items:center;margin-top:12px}
    .small{font-size:13px}
    .notice{margin-top:8px;color:#ffdede}
    @media(max-width:1000px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="app">
    <h1>Lucky Pit ‚Äî Correcci√≥n final</h1>
    <div class="grid">
      <section class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="muted">Ronda <strong id="round">1</strong> ‚Ä¢ Meta <strong id="goal">90</strong></div>
            <div style="margin-top:6px" class="muted">Dinero: <strong id="coins">0</strong> ‚Ä¢ Tickets: <strong id="tickets">0</strong> ‚Ä¢ ATM: <strong id="atm">0</strong></div>
          </div>
          <div class="muted">Tiradas restantes: <strong id="spinsLeft">0</strong></div>
        </div>

        <div class="reels" id="reelsContainer" style="margin-top:12px"></div>

        <div class="controls">
          <button id="spinBtn">Girar (1)</button>
          <button id="multiSpinBtn">Girar x3</button>
          <button id="bankBtn">Depositar ATM</button>
          <button id="rerollStoreBtn">Re-roll Tienda (-50 coins)</button>
          <button id="payBtn" style="background:#7efc6b;color:#042126;font-weight:800">Pagar deuda</button>
        </div>

        <div class="notice">Arreglado: Evaluaci√≥n comprueba todas las 8 l√≠neas posibles (3 filas, 3 columnas, 2 diagonales). Tickets se suman correctamente.</div>
        <div class="history" id="history"></div>
      </section>

      <aside class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="muted">Progresi√≥n</div>
            <div class="progress small"><div>Rondas completadas:</div><div id="roundsDone">0</div></div>
            <div class="progress small"><div>Puntos de desbloqueo:</div><div id="unlockPoints">0</div></div>
          </div>
          <div>
            <div class="muted">Desbloqueos</div>
            <div class="small muted">Nuevos amuletos se desbloquean al avanzar de ronda o acumular puntos.</div>
          </div>
        </div>

        <div class="muted" style="margin-top:12px">Tienda de Amuletos</div>
        <div id="store" class="store"></div>

        <div class="muted" style="margin-top:8px">Amuletos equipados</div>
        <div id="equipped" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px"></div>

        <div class="muted" style="margin-top:10px">Registro de activaciones</div>
        <div id="activelog" class="activelog"></div>

        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="newRunBtn">Nueva Partida</button>
          <button id="saveBtn">Guardar</button>
          <button id="loadBtn">Cargar</button>
        </div>
      </aside>
    </div>
  </div>

<script>
// Final fixes requested by user:
// - Evaluate all 8 possible 3x3 lines (3 rows, 3 columns, 2 diagonals)
// - Ensure multi-spin reliably does 3 sequential spins and UI unblocks
// - Prevent stuck spinLocked state (always reset even on failures)
// - Ensure tickets increment correctly and persist
// - Improve animation reliability with robust transitionend fallback

// ---------- DATA ----------
const SYMBOLS = [
  {id:'üçã',name:'Lemon',weight:11,value:4},
  {id:'üçí',name:'Cherry',weight:11,value:6},
  {id:'üçÄ',name:'Clover',weight:10,value:9},
  {id:'üîî',name:'Bell',weight:9,value:12},
  {id:'üíé',name:'Diamond',weight:7,value:20},
  {id:'7Ô∏è‚É£',name:'Seven',weight:6,value:35}
];
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}

// ---------- STATE ----------
let state = {
  coins:150, tickets:3, atm:0, round:1, goal:90, spinsLeft:10, luck:0,
  store:[], equipped:[], symbols:JSON.parse(JSON.stringify(SYMBOLS)),
  roundsCompleted:0, unlockPoints:0, unlockedAmulets:[], rerollCost:50
};

// simplified catalog (keeps previous variety)
const AMULETS_CATALOG = [
  {id:'more_cherries',name:'M√°s Cerezas',cost:3,desc:'Aumenta peso de Cherry +8',requiredRound:1,apply:()=>({mod:{Cherry:8}})},
  {id:'extra_spin',name:'Tiradas Extra',cost:4,desc:'+2 spins cada ronda completada',requiredRound:1,apply:()=>({spins:2})},
  {id:'interest_plus',name:'Inter√©s +',cost:5,desc:'ATM gana +4% por ronda',requiredRound:2,apply:()=>({interest:0.04})},
  {id:'ticket_seed',name:'Cloverpot',cost:3,desc:'Ganas +1 ticket al final si te quedan >=3',requiredRound:1,apply:()=>({ticketSeed:1})},
  {id:'lucky_charm',name:'Lucky Charm',cost:7,desc:'Cuando ganas, +3 suerte',requiredRound:1,apply:()=>({luck:3})},
  {id:'double_value',name:'Valor Doble',cost:6,desc:'Si obtienes combo duplica su valor',requiredRound:2,apply:()=>({doubleOnCombo:true})},
  {id:'reroll_cheaper',name:'Re-roll barato',cost:5,desc:'Reduce coste de re-roll a 25 coins',requiredRound:2,apply:()=>({rerollDiscount:25})},
  {id:'spin_refund',name:'Reembolso spin',cost:6,desc:'10% de coins devueltos tras una tirada sin premio',requiredRound:2,apply:()=>({refundPct:0.1})},
  {id:'small_bank',name:'Banco Peque√±o',cost:4,desc:'Al depositar ATM+5% adicional a veces',requiredRound:3,apply:()=>({atmBonus:0.05})},
  {id:'safety_net',name:'Red de seguridad',cost:6,desc:'Si pierdes por falta de tiradas, recuperas parte de coins',requiredRound:1,apply:()=>({savePct:0.25})}
];

// ---------- HELPERS ----------
function findCatalog(id){ return AMULETS_CATALOG.find(a=>a.id===id); }
function weightedPick(weights){ const s=weights.reduce((a,b)=>a+b,0); let r=Math.random()*s; for(let i=0;i<weights.length;i++){ r-=weights[i]; if(r<0) return i; } return weights.length-1; }
function buildWeights(){ const base=state.symbols.map(s=>s.weight); state.equipped.forEach(e=>{ const cat=findCatalog(e.id); if(cat && cat.apply().mod){ const mod=cat.apply().mod; if(mod.Cherry) base[state.symbols.findIndex(x=>x.name==='Cherry')] += mod.Cherry; } }); const luckBias=Math.floor(state.luck/3); if(luckBias>0) for(let i=0;i<base.length;i++) base[i]+=luckBias; return base; }

// ---------- REELS & ANIMATION ----------
const reelsContainer = document.getElementById('reelsContainer');
function createReels(){ reelsContainer.innerHTML=''; for(let i=0;i<3;i++){ const r=document.createElement('div'); r.className='reel'; const strip=document.createElement('div'); strip.className='strip'; r.appendChild(strip); reelsContainer.appendChild(r); } }
createReels();
const CELL_TOTAL = 54; // fixed cell height to avoid layout reads

function buildStripWithTarget(visibleTriple){ const sequence=state.symbols.map(s=>s.id); const repeats=3; const arr=[]; for(let i=0;i<repeats;i++) sequence.forEach(sym=>arr.push(sym)); arr.push(...visibleTriple); return arr; }

function renderStripsQuick(strips){ for(let ri=0;ri<3;ri++){ const reel=reelsContainer.children[ri]; const strip=reel.querySelector('.strip'); strip.innerHTML=''; const frag=document.createDocumentFragment(); for(let k=0;k<strips[ri].length;k++){ const d=document.createElement('div'); d.className='cell bg'; d.textContent = strips[ri][k]; frag.appendChild(d); } strip.appendChild(frag); strip.style.transition='none'; strip.style.transform='translateY(0px)'; } }

function computeFinalTranslateFixed(reelIndex, stripLength){ const targetIdx = stripLength - 3; const centerOffset = 1; const translateCells = targetIdx - centerOffset; return -translateCells * CELL_TOTAL; }

function animateStripsToTargets(strips,durations){
  return new Promise(resolve=>{
    renderStripsQuick(strips);
    requestAnimationFrame(()=>{
      let completed=0; let finished=false;
      for(let ri=0;ri<3;ri++){
        const strip=reelsContainer.children[ri].querySelector('.strip');
        const stripLen=strips[ri].length; const finalY=computeFinalTranslateFixed(ri,stripLen); const dur=durations[ri];
        const onEnd = ()=>{ if(finished) return; completed++; if(completed>=3){ finished=true; resolve(); } };
        // attach and also fallback
        strip.addEventListener('transitionend', onEnd);
        setTimeout(()=>{ if(!finished && completed<3){ finished=true; resolve(); } }, dur+300);
        requestAnimationFrame(()=>{ strip.style.transition = `transform ${dur}ms cubic-bezier(.15,.9,.15,1)`; strip.style.transform = `translateY(${finalY}px)`; });
      }
    });
  });
}

// ---------- ROLL & EVALUATION (all 8 lines) ----------
function rollDeterministic(){ const weights = buildWeights(); const grid=[[],[],[]]; // column-major
  // keep early bias to help progression
  const baseComboChance=0.2; const roundBoost=Math.max(0,0.08-(state.round-1)*0.02); const comboChance = baseComboChance + roundBoost + (state.luck/40);
  if(Math.random() < comboChance){ const idx=weightedPick(weights); const sym = state.symbols[idx].id; for(let c=0;c<3;c++){ grid[c][1]=sym; for(let r=0;r<3;r++) if(r!==1) grid[c][r]=state.symbols[weightedPick(weights)].id; } return grid; }
  for(let c=0;c<3;c++){ for(let r=0;r<3;r++){ grid[c][r] = state.symbols[weightedPick(weights)].id; } }
  return grid; }

function evaluateGrid(grid){ // grid is column-major [col][row]
  const combos = [];
  // rows
  for(let r=0;r<3;r++){ if(grid[0][r]===grid[1][r] && grid[1][r]===grid[2][r]) combos.push(grid[0][r]); }
  // cols
  for(let c=0;c<3;c++){ if(grid[c][0]===grid[c][1] && grid[c][1]===grid[c][2]) combos.push(grid[c][0]); }
  // diagonals
  if(grid[0][0]===grid[1][1] && grid[1][1]===grid[2][2]) combos.push(grid[0][0]);
  if(grid[0][2]===grid[1][1] && grid[1][1]===grid[2][0]) combos.push(grid[0][2]);
  let coins = 0; combos.forEach(sym=>{ const s = state.symbols.find(x=>x.id===sym); if(s) coins += s.value; });
  return {coins, combos}; }

// ---------- AMULETS: activation & effects ----------
function logActivation(text){ const el=document.getElementById('activelog'); const d=document.createElement('div'); d.style.padding='6px'; d.style.borderBottom='1px solid rgba(255,255,255,0.02)'; d.textContent = '['+new Date().toLocaleTimeString()+'] '+text; el.prepend(d); while(el.childElementCount>120) el.removeChild(el.lastChild); }

function applyAmuletEffectsOnEvent(event, context){
  // event: 'onWin','onLose','onDeposit','onRoundEnd','onBuy','onFail'
  state.equipped.forEach(inst=>{
    const cat = findCatalog(inst.id);
    if(!cat) return;
    const effect = cat.apply();
    if(event==='onWin' && effect.luck && context && context.ev && context.ev.combos.length>0){ state.luck = clamp(state.luck + effect.luck,0,10); logActivation(`${cat.name} -> +${effect.luck} luck`); }
    if(event==='onWin' && effect.doubleOnCombo && context.ev.combos.length>0){ logActivation(`${cat.name} -> duplicador activo para combos`); }
    if(event==='onLose' && effect.refundPct && context && context.gained===0){ const ref = Math.floor(context.lastStake * effect.refundPct); state.coins += ref; logActivation(`${cat.name} -> refund +${ref}`); }
    if(event==='onDeposit' && effect.atmBonus && context){ const bonus = Math.floor(context.amount * effect.atmBonus); state.atm += bonus; logActivation(`${cat.name} -> ATM bonus +${bonus}`); }
    if(event==='onRoundEnd' && effect.spins){ state.spinsLeft += effect.spins; logActivation(`${cat.name} -> +${effect.spins} spins por finalizar ronda`); }
    if(event==='onRoundEnd' && effect.ticketSeed && state.tickets>=3){ state.tickets += effect.ticketSeed; logActivation(`${cat.name} -> +${effect.ticketSeed} tickets por seed`); }
    if(event==='onFail' && effect.savePct){ const recover = Math.floor(state.coins * effect.savePct); state.coins += recover; logActivation(`${cat.name} -> red de seguridad +${recover}`); }
    if(event==='onBuy' && effect.ticketBack){ state.tickets += effect.ticketBack; logActivation(`${cat.name} -> ticket back +${effect.ticketBack}`); }
    if(effect.rerollDiscount){ state.rerollCost = effect.rerollDiscount; logActivation(`${cat.name} -> re-roll cost ahora ${state.rerollCost}`); }
  });
}

// ---------- SPIN FLOW & STABILITY ----------
let spinLocked=false;
function spinOnce(){
  if(spinLocked) return Promise.reject('busy');
  if(state.spinsLeft<=0) return Promise.reject('no-spins');
  spinLocked = true;
  const finalGrid = rollDeterministic();
  const strips = []; for(let c=0;c<3;c++) strips.push(buildStripWithTarget(finalGrid[c]));
  const durations = [700+Math.random()*220,900+Math.random()*220,1050+Math.random()*220];
  const lastStake = 1;
  return animateStripsToTargets(strips,durations).then(()=>{
    // apply evaluation
    state.spinsLeft -= 1;
    const ev = evaluateGrid(finalGrid);
    let gained = ev.coins;
    // apply double-value amulet if any
    if(state.equipped.some(e=>findCatalog(e.id).apply().doubleOnCombo) && ev.combos.length>0) gained *= 2;
    // tickets increment for each combo (each line)
    if(ev.combos.length>0){ state.tickets += ev.combos.length; }
    state.coins += gained;
    // apply amulet triggers
    const ctx = {ev,gained,lastStake};
    if(ev.combos.length>0){ applyAmuletEffectsOnEvent('onWin', ctx); }
    else{ applyAmuletEffectsOnEvent('onLose', ctx); }

    // log and UI
    addHistory(finalGrid, ev, gained);
    renderUI(); autosave();
    spinLocked = false;
    return {ev,gained};
  }).catch(err=>{
    // ensure unlock UI on any error
    spinLocked = false;
    throw err;
  });
}

async function runSpins(count){
  if(spinLocked) return;
  toggleUI(true);
  for(let i=0;i<count;i++){
    if(state.spinsLeft<=0) break;
    try{ await spinOnce(); }catch(e){ console.warn('spin aborted',e); break; }
    await new Promise(r=>setTimeout(r,220));
  }
  toggleUI(false);
}

// ---------- UI / STORE ----------
function genStore(){ const list = AMULETS_CATALOG.map(a=> ({...a, unlocked: state.unlockedAmulets.includes(a.id)})); state.store = list; }
function buyAmulet(i){ const a = state.store[i]; if(!a) return; if(!a.unlocked){ alert('A√∫n no desbloqueado'); return; } if(state.tickets < a.cost){ alert('No tienes tickets'); return; } if(state.equipped.length>=6){ alert('M√°x 6 amuletos'); return; } state.tickets -= a.cost; state.equipped.push({id:a.id,name:a.name}); logActivation(`Comprado y equipado: ${a.name}`); applyAmuletEffectsOnEvent('onBuy',{}); renderUI(); autosave(); }
function unequip(i){ const rem = state.equipped.splice(i,1); if(rem.length) logActivation(`Quitar: ${rem[0].name}`); renderUI(); autosave(); }

function depositATM(){ const amount = Math.min(state.coins,50); if(amount<=0){ alert('No tienes coins'); return; } state.coins -= amount; state.atm += amount; applyAmuletEffectsOnEvent('onDeposit',{amount}); logActivation(`Depositado ${amount} al ATM`); renderUI(); autosave(); }

function rerollStore(){ const cost = state.rerollCost || state.rerollCost === 0 ? state.rerollCost : 50; if(state.coins < cost){ alert('Necesitas ' + cost + ' coins'); return; } state.coins -= cost; genStore(); renderUI(); autosave(); logActivation(`Re-roll tienda (-${cost})`); }

function addHistory(grid,ev,gained){ const el=document.getElementById('history'); const e=document.createElement('div'); e.style.padding='6px'; e.style.borderBottom='1px solid rgba(255,255,255,0.02)'; e.innerHTML = `<strong>+${gained} coins</strong> ‚Äî Combos: ${ev.combos.join(', ') || '‚Äî'}`; el.prepend(e); while(el.childElementCount>120) el.removeChild(el.lastChild); if(ev.combos.length>0) showFlash(ev.combos.length>=2 ? `BIG WIN +${gained}` : `Win +${gained}`); }
function showFlash(text){ const f=document.createElement('div'); f.style.position='fixed'; f.style.left='50%'; f.style.top='8%'; f.style.transform='translateX(-50%)'; f.style.background='linear-gradient(90deg,var(--accent),var(--accent2))'; f.style.color='#041226'; f.style.padding='10px 16px'; f.style.borderRadius='10px'; f.style.fontWeight='800'; document.body.appendChild(f); setTimeout(()=>{ f.remove(); },1400); }

function renderUI(){ document.getElementById('coins').textContent = state.coins; document.getElementById('tickets').textContent = state.tickets; document.getElementById('atm').textContent = state.atm; document.getElementById('goal').textContent = state.goal; document.getElementById('spinsLeft').textContent = state.spinsLeft; document.getElementById('round').textContent = state.round; document.getElementById('roundsDone').textContent = state.roundsCompleted; document.getElementById('unlockPoints').textContent = state.unlockPoints;
  const storeEl = document.getElementById('store'); storeEl.innerHTML=''; state.store.forEach((a,i)=>{ const row=document.createElement('div'); row.className = 'amulet-row' + (a.unlocked ? '' : ' locked'); row.innerHTML = `<div><strong>${a.name}</strong><div class='muted' style='font-size:12px'>${a.desc}</div></div><div style='display:flex;gap:8px;align-items:center'><div class='muted small'>${a.unlocked?('Costo: '+a.cost+'t'):( 'Requiere ronda '+a.requiredRound)}</div><button ${a.unlocked? '':'disabled'}>${a.unlocked? 'Comprar':'Bloqueado'}</button></div>`; const btn=row.querySelector('button'); if(a.unlocked) btn.onclick = ()=>buyAmulet(i); storeEl.appendChild(row); });
  const eq = document.getElementById('equipped'); eq.innerHTML=''; state.equipped.forEach((a,i)=>{ const d=document.createElement('div'); d.style.minWidth='140px'; d.style.background='rgba(255,255,255,0.02)'; d.style.padding='6px'; d.style.borderRadius='8px'; d.innerHTML = `<div><strong>${a.name}</strong><div class='muted' style='font-size:12px'>Trigger: ${findCatalog(a.id).apply ? Object.keys(findCatalog(a.id).apply()).join(', ') : 'passive'}</div></div>`; const btn=document.createElement('button'); btn.textContent='Quitar'; btn.onclick = ()=>unequip(i); d.appendChild(btn); eq.appendChild(d); });
  const payBtn = document.getElementById('payBtn'); if(payBtn) payBtn.disabled = state.coins < state.goal; }

function toggleUI(disabled){ const all = document.querySelectorAll('button'); all.forEach(b=>b.disabled = !!disabled); const pay = document.getElementById('payBtn'); if(pay) pay.disabled = disabled || state.coins < state.goal; }

// ---------- PROGRESSION ----------
function completeRound(manual){ if(manual){ if(state.coins < state.goal){ alert('No tienes suficiente'); return; } state.coins -= state.goal; }
  const interestBonus = Math.floor(state.atm * (0.02 + (state.equipped.some(e=>findCatalog(e.id).apply().interest)?0.04:0)));
  state.coins += interestBonus; state.roundsCompleted +=1; state.unlockPoints += 2 + Math.floor(state.round/2);
  // unlock according to round
  AMULETS_CATALOG.forEach(a=>{ if(!state.unlockedAmulets.includes(a.id) && state.roundsCompleted >= a.requiredRound){ state.unlockedAmulets.push(a.id); logActivation(`Desbloqueado: ${a.name}`); } });
  applyAmuletEffectsOnEvent('onRoundEnd',{});
  state.round +=1; state.goal = Math.floor(state.goal * 1.5 + 25); state.spinsLeft = 8 + state.equipped.reduce((s,a)=>s + (findCatalog(a.id).apply().spins || 0),0);
  renderUI(); autosave(); }

function payDebt(){ if(state.coins < state.goal){ alert('No tienes suficiente'); return; } completeRound(true); logActivation('Pagaste la deuda manualmente'); }

function checkFailure(){ if(state.spinsLeft<=0){ applyAmuletEffectsOnEvent('onFail',{}); const lost = Math.min(Math.floor(state.coins * 0.12), 40); state.coins = Math.max(0, state.coins - lost); logActivation(`Fin de tiradas: perdiste ${lost}`); renderUI(); autosave(); } }

// ---------- PERSISTENCE ----------
function autosave(){ localStorage.setItem('lp_state_vfinal', JSON.stringify(state)); }
function saveManual(){ localStorage.setItem('lp_state_manual', JSON.stringify(state)); alert('Guardado manual OK'); }
function loadAuto(){ const s = localStorage.getItem('lp_state_vfinal'); if(!s){ newRun(); return; } state = JSON.parse(s); initUnlocked(); genStore(); renderUI(); }
function loadManual(){ const s = localStorage.getItem('lp_state_manual'); if(!s){ loadAuto(); return; } state = JSON.parse(s); initUnlocked(); genStore(); renderUI(); }

// ---------- INIT & EVENTS ----------
function initUnlocked(){ if(!state.unlockedAmulets || state.unlockedAmulets.length===0){ state.unlockedAmulets = AMULETS_CATALOG.filter(a=>a.requiredRound<=2).map(a=>a.id); } }
function genStore(){ const list = AMULETS_CATALOG.map(a=> ({...a, unlocked: state.unlockedAmulets.includes(a.id)})); state.store = list; }
function newRun(){ state = { coins:150,tickets:3,atm:0,round:1,goal:90,spinsLeft:10,luck:0,store:[],equipped:[],symbols:JSON.parse(JSON.stringify(SYMBOLS)), roundsCompleted:0, unlockPoints:0, unlockedAmulets:[], rerollCost:50 }; initUnlocked(); genStore(); renderUI(); autosave(); }

document.getElementById('spinBtn').onclick = ()=>{ runSpins(1); };
document.getElementById('multiSpinBtn').onclick = ()=>{ runSpins(3); };
document.getElementById('bankBtn').onclick = ()=>{ depositATM(); };
document.getElementById('rerollStoreBtn').onclick = ()=>{ rerollStore(); };
document.getElementById('payBtn').onclick = ()=>{ payDebt(); };
document.getElementById('newRunBtn').onclick = ()=>{ if(confirm('Iniciar nueva run?')) newRun(); };
document.getElementById('saveBtn').onclick = ()=>saveManual();
document.getElementById('loadBtn').onclick = ()=>loadManual();

initUnlocked(); genStore(); renderUI(); createReels(); autosave();
</script>
</body>
</html>
